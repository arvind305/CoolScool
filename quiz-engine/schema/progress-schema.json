{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://qming-kids.app/schemas/progress-v1.0.json",
  "title": "User Progress Schema",
  "description": "Schema for tracking user progress per concept and topic. Complies with North Star ยง9 (Proficiency, Not Marks) and ยง10 (Question Selection).",
  "type": "object",
  "required": ["version", "user_id", "cam_reference", "concepts", "topics", "total_xp", "created_at", "updated_at"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Progress data version",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "user_id": {
      "type": "string",
      "description": "Unique user identifier (can be anonymous for MVP)"
    },
    "cam_reference": {
      "type": "object",
      "required": ["cam_version", "board", "class", "subject"],
      "properties": {
        "cam_version": { "type": "string" },
        "board": { "type": "string", "enum": ["ICSE"] },
        "class": { "type": "integer" },
        "subject": { "type": "string", "enum": ["Mathematics"] }
      }
    },
    "concepts": {
      "type": "object",
      "description": "Mastery tracking per concept. Key is concept_id (e.g., T01.01.C01)",
      "additionalProperties": {
        "$ref": "#/definitions/concept_progress"
      }
    },
    "topics": {
      "type": "object",
      "description": "Aggregated progress per topic. Key is topic_id (e.g., T01.01)",
      "additionalProperties": {
        "$ref": "#/definitions/topic_progress"
      }
    },
    "total_xp": {
      "type": "integer",
      "description": "Total XP earned across all concepts",
      "minimum": 0
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    }
  },
  "definitions": {
    "concept_progress": {
      "type": "object",
      "required": ["concept_id", "current_difficulty", "mastery_by_difficulty", "total_attempts", "xp_earned"],
      "properties": {
        "concept_id": {
          "type": "string",
          "pattern": "^T\\d{2}\\.\\d{2}\\.C\\d{2}$"
        },
        "current_difficulty": {
          "type": "string",
          "description": "Current difficulty level for question selection",
          "enum": ["familiarity", "application", "exam_style"]
        },
        "mastery_by_difficulty": {
          "type": "object",
          "description": "Mastery tracking per difficulty level",
          "properties": {
            "familiarity": { "$ref": "#/definitions/difficulty_mastery" },
            "application": { "$ref": "#/definitions/difficulty_mastery" },
            "exam_style": { "$ref": "#/definitions/difficulty_mastery" }
          }
        },
        "total_attempts": {
          "type": "integer",
          "minimum": 0
        },
        "total_correct": {
          "type": "integer",
          "minimum": 0
        },
        "xp_earned": {
          "type": "integer",
          "minimum": 0
        },
        "last_attempted_at": {
          "type": "string",
          "format": "date-time"
        },
        "question_history": {
          "type": "array",
          "description": "History of question attempts for this concept",
          "items": {
            "$ref": "#/definitions/question_attempt"
          }
        }
      }
    },
    "difficulty_mastery": {
      "type": "object",
      "required": ["attempts", "correct", "streak", "mastered"],
      "properties": {
        "attempts": {
          "type": "integer",
          "description": "Total attempts at this difficulty",
          "minimum": 0
        },
        "correct": {
          "type": "integer",
          "description": "Total correct answers at this difficulty",
          "minimum": 0
        },
        "streak": {
          "type": "integer",
          "description": "Current correct streak (resets on wrong answer)",
          "minimum": 0
        },
        "mastered": {
          "type": "boolean",
          "description": "True if 4/5 correct at this difficulty (North Star ยง10)"
        },
        "mastered_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "question_attempt": {
      "type": "object",
      "required": ["question_id", "difficulty", "is_correct", "attempted_at"],
      "properties": {
        "question_id": {
          "type": "string"
        },
        "difficulty": {
          "type": "string",
          "enum": ["familiarity", "application", "exam_style"]
        },
        "is_correct": {
          "type": "boolean"
        },
        "xp_earned": {
          "type": "integer",
          "minimum": 0
        },
        "attempted_at": {
          "type": "string",
          "format": "date-time"
        },
        "time_taken_ms": {
          "type": "integer",
          "description": "Time taken to answer in milliseconds"
        }
      }
    },
    "topic_progress": {
      "type": "object",
      "required": ["topic_id", "proficiency_band", "concepts_count", "concepts_started", "concepts_mastered"],
      "properties": {
        "topic_id": {
          "type": "string",
          "pattern": "^T\\d{2}\\.\\d{2}$"
        },
        "proficiency_band": {
          "type": "string",
          "description": "Current proficiency band per North Star ยง9",
          "enum": ["not_started", "building_familiarity", "growing_confidence", "consistent_understanding", "exam_ready"]
        },
        "concepts_count": {
          "type": "integer",
          "description": "Total concepts in this topic"
        },
        "concepts_started": {
          "type": "integer",
          "description": "Number of concepts with at least one attempt"
        },
        "concepts_mastered": {
          "type": "integer",
          "description": "Number of concepts with exam_style mastered"
        },
        "total_attempts": {
          "type": "integer",
          "minimum": 0
        },
        "total_correct": {
          "type": "integer",
          "minimum": 0
        },
        "xp_earned": {
          "type": "integer",
          "minimum": 0
        },
        "last_attempted_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    }
  }
}
